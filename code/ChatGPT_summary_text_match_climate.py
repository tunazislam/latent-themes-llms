import os
import openai
import pandas as pd
import sys
import time  # Import the 'time' module to handle rate limit resets
import re
from transformers import GPT2Tokenizer

# Initialize the tokenizer
tokenizer = GPT2Tokenizer.from_pretrained("gpt2")
# Set your OpenAI API key
openai.api_key = ' '  # Replace with your API key

df = pd.read_csv('data/related_ads.csv')
df = df.loc[:, ~df.columns.str.contains('^Unnamed')]
df = df.reset_index(drop=True)
print(df)

# Initialize an empty list to store the assistant's replies
assistant_replies = []

# Function to make API requests and handle rate limits
def make_api_request(prompt):
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                       {
					    "role": "system",
					      "content": "Don't generate new summary. Choose the most matched summary from the given 25 summaries."
					    },
                     	{
                      		"role": "user", "content": prompt
                      	}
                      ],
            # temperature=0.7,
            temperature=1,
            max_tokens=40,
            top_p=1.0,
            frequency_penalty=0,
            presence_penalty=0
        )
        return response.choices[0].message["content"]
    except openai.error.RateLimitError as e:
        # Handle rate limit exceeded error by waiting for a fixed time (e.g., 60 seconds)
        print("Rate limit exceeded. Waiting for 60 seconds...")
        time.sleep(60)
        return make_api_request(prompt)  # Retry the request after waiting


def remove_links(text):
    # Define a regular expression pattern to match URLs
    url_pattern = r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'

    # Remove URLs from the text
    text_without_links = re.sub(url_pattern, '', text)

    return text_without_links

def remove_line_breaks_and_links(text):
    # Remove line breaks
    text_without_line_breaks = re.sub(r'\n{2,}', '\n', text)
    removew_leading_indent = re.sub(r'\n\s+', '\n', text_without_line_breaks)  # Remove leading indentation
    
    # Remove links
    text_without_links = remove_links(removew_leading_indent)

    return text_without_links


# Iterate through the DataFrame and send each text as a user message
for index, row in df.iterrows():
    text = row['ad_creative_body']
    cleaned_text = remove_line_breaks_and_links(text).strip()
    # shortened_text = cleaned_text[:300]  # Example of shortening the prompt text
    shortened_text = cleaned_text  # i don't want to short
    user_message = "We have the following 25 summaries:\n\n1. Summary_Economy_pro: \nThe provided texts collectively emphasize the importance of the oil and natural gas industry in supporting local jobs, economic growth, and community development. They express concerns about proposed bans on natural gas and oil, warning of potential job losses and negative economic impacts. The texts call for support of the oil and gas industry, highlighting its contributions to local economies and communities while advocating for a sustainable future.\n\n2. Summary_ClimateSolution: \nThe provided texts collectively advocate for the role of natural gas in advancing a cleaner and more sustainable energy future. They highlight natural gas as an essential tool for reducing carbon emissions, providing affordable and reliable energy, and complementing renewable energy sources like wind and solar. The texts emphasize the importance of using natural gas to address the dual challenge of meeting energy needs and protecting the environment while working towards ambitious carbon reduction goals, such as reaching net-zero emissions by 2045.\n\n3. Summary_Pragmatism:\nThe provided texts collectively stress the vital role of reliable and affordable natural gas and oil in enabling modern life. They highlight that in 2020, natural gas and oil accounted for nearly 70% of America's energy supply, and projections suggest they will continue to meet approximately 70% of the nation's energy needs by 2050, as indicated by the U.S. Energy Information Administration. The texts call attention to the significance of American oil and gas production in maintaining affordable energy and invite individuals to share their priorities in this regard.\n\n4. Summary_Patriotism:\nThe provided texts collectively emphasize the importance of U.S. energy leadership and innovation, highlighting the country's position as a top global energy producer while actively working to reduce greenhouse gas emissions. They express concerns about potential cutbacks in local oil and gas production, citing potential consequences such as increased reliance on foreign oil imports and higher gas prices for Californians. The texts argue against shutting off American oil and natural gas production, pointing out that such actions could strengthen other nations while negatively impacting U.S. jobs, economic security, and national security. Additionally, they underscore the broader impacts of U.S. oil and natural gas production on daily life, including its role in fertilizer production and its significance in ensuring food supply and availability. The texts call for action to protect America's energy future and support natural gas and consumer choice through petitions, and they highlight the U.S.'s achievement as the world's No. 1 exporter of liquefied natural gas, particularly in response to energy demands in Europe.\n\n5. Summary_AgainstClimatePolicy:\nThe provided texts collectively convey a sense of urgency and concern regarding the oil and gas industry, emphasizing the need for support and resistance against what they perceive as threats to the industry's survival. They criticize progressive and Democratic energy policies, particularly the Green New Deal, as potentially devastating to American workers and the economy. The texts also criticize the Biden administration's energy policies, linking them to high gas prices and a reliance on emergency reserves. They call for action to prioritize and protect the American energy industry, with an emphasis on opposing what they view as radical policies and mandates. Additionally, the texts highlight the role of the oil and gas industry in addressing climate challenges through innovation and expertise while expressing fears of job loss and economic consequences if certain policies are implemented.\n\n6. Summary_Economy_clean:\nThe provided texts collectively advocate for a clean energy future in the United States and emphasize the potential for job creation and economic benefits associated with clean energy initiatives. They highlight the growth of clean energy sectors and argue that investments in renewable energy are generating good-paying jobs across various occupations and regions. The texts contrast clean energy with fossil fuels, suggesting that clean energy is not only environmentally responsible but also economically advantageous. They call on Congress to support clean energy policies and investments as a means to strengthen the American economy, create jobs, lower energy costs, and mitigate climate change, ultimately promoting a clean energy-focused approach to economic growth.\n\n7. Summary_HumanHealth:\nThe provided texts collectively emphasize the significant and urgent health impacts of climate change, highlighting the range of dangers it poses, including cardiovascular and respiratory issues, food security, the spread of diseases, and more. They stress the need for awareness and action to address these health challenges linked to climate change, with mentions of governmental initiatives and organizations dedicated to addressing climate-related health concerns. The texts underscore that climate change is already harming people and communities, affecting vulnerable populations, and call for support and action to mitigate these adverse health effects.\n\n8. Summary_FutureGeneration:\nThe provided texts collectively emphasize the grave threat of climate change to children's health and well-being. They cite alarming statistics, including data from the World Health Organization, that underscore the vulnerability of young children to climate-related health issues. The texts stress the urgent need to protect children from the impacts of climate change and highlight the various health risks they face, including premature births, birth defects, and increased emergency room visits. They call for action to address climate change to safeguard the future of children and grandchildren, emphasizing that inaction comes at a high cost to children's health and well-being. The texts also acknowledge the anxiety and concerns that climate change is causing among young people and suggest ways to support and address their anxieties.\n\n9. Summary_Environmental:\nThe provided texts collectively address the urgency and breadth of the climate crisis, emphasizing its far-reaching impacts on various aspects of society and the environment. They highlight alarming trends such as the rapid warming of oceans, the increasing frequency of extreme weather events, and the dire consequences of climate change on ecosystems, economies, and public health. The texts call for collective action and emphasize the role of individuals in combating climate change, urging the sharing of ideas and solutions. They also stress the need to address the root causes, including greenhouse gas emissions from fossil fuels, and promote carbon capture as a key strategy for decarbonizing the global energy system. Overall, the texts underscore the severity of the climate emergency and the importance of taking immediate action to mitigate its effects and protect vulnerable communities and ecosystems.\n\n10. Summary_Animals:\nThe provided texts collectively highlight the severe impact of climate change on wildlife, fisheries, birds and ecosystems. They mention rising temperatures, increased droughts, fires, intense storms, and floods that threaten various species and their habitats. Studies reveal that climate change could lead to the extinction of one-third of species in the next 50 years, with particular vulnerabilities in South America. The texts emphasize the urgent need for action to protect wildlife from the consequences of climate change, emphasizing the role of renewable energy development that must consider the needs of wildlife. They call for an understanding of the interconnected crises of climate change and biodiversity loss, urging collective efforts to address both challenges.\n\n11. Summary_AltEnergy:  \nThe provided texts collectively advocate for the adoption of renewable energy sources as a cleaner, cheaper, and more sustainable alternative to fossil fuels. They emphasize the benefits of transitioning to renewables, including reducing carbon footprints, enhancing grid reliability, and mitigating the impact of rising gas prices. The texts highlight the rapid growth of renewable energy in the United States, with clean power sources like wind, solar, and hydrogen accounting for a significant share of electricity generation. They stress the urgency of making this transition to combat climate change, citing the irreversible impacts looming by 2030. Additionally, they mention various projects and initiatives aimed at promoting clean energy and energy independence, such as repurposing coal plants into renewable energy hubs and proposed solar farms. Finally, they encourage energy-conscious practices like using electricity during off-peak hours to harness clean energy effectively.\n\n12. Summary_SupportClimatePolicy:  \nThe provided texts collectively advocate for the passage of the Build Back Better Act, emphasizing its significance in addressing climate change and promoting a clean energy future. They highlight the key provisions of the bill, including cutting pollution by 50% by 2030, creating clean energy jobs, and lowering utility bills. The texts stress the urgency of taking action to combat climate change and emphasize that it's a historic opportunity to invest in meaningful climate action and transition to a carbon-zero grid. Additionally, some texts criticize the fossil fuel industry for its role in climate change and call for holding polluters accountable. Overall, the focus is on the importance of the Build Back Better Act in advancing climate goals and environmental justice.\n\n13. Summary_PoliticalAffliation:  \nThe provided texts collectively highlight concerns about the influence of the oil and gas industry on climate change policies. They emphasize that despite claims of caring about climate change, these industries spend significant amounts on lobbying to block regulations and protect their subsidies. The texts mention the substantial sums spent on climate lobbying by major oil and gas companies and argue that these actions hinder meaningful climate action. They also discuss political contributions to lawmakers and emphasize the need to address climate change without being influenced by industry lobbying. Additionally, some texts reference specific instances where lobbyists have allegedly undermined climate legislation or influenced infrastructure bills to prioritize industry interests over environmental concerns. Overall, the focus is on revealing the industry's efforts to shape climate policies to their advantage.\n\n14. Summary_BidenGasPriceIncrease:  \nThe provided texts collectively express strong disapproval and criticism of President Joe Biden's administration, focusing on various issues such as rising gas prices, inflation, the southern border crisis, and energy policies. Some texts call for Joe Biden's resignation and invite readers to participate in approval polls, while others highlight specific concerns, like the increase in gas prices and the cancellation of certain pipelines, portraying these actions as detrimental to the American economy. Overall, these texts present a negative view of Joe Biden's leadership and policy decisions.\n\n15. Summary_AgainstCorporateInterests:\nThe provided texts largely revolve around progressive candidates running for Congress and their calls for grassroots support. These candidates emphasize their commitment to economic justice, racial equity, climate action, and progressive policies such as a Green New Deal, Medicare for All, and universal housing. They criticize their opponents for receiving significant contributions from corporations and lobbyists and highlight the need for people-powered campaigns. Some texts also mention the importance of supporting incumbent progressive Congress members, such as the Squad, to pass transformative legislation like the Build Back Better Agenda. Overall, these texts aim to rally support for progressive candidates and causes while advocating for a shift away from corporate influence in politics.  \n\n16. Summary_GasTax:\nThe provided texts revolve around opposing proposed gas tax increases in various states. They emphasize concerns about the financial burden on families, rising gas prices, and the potential for gasoline shortages. The texts encourage people to sign petitions or participate in rallies to voice their opposition to these tax hikes. Additionally, some texts highlight the current tax rates and the impact of previous tax increases, framing the issue as a matter of transparency and affordability for consumers. Overall, the focus is on mobilizing public sentiment against gas tax increases in different states.\n\n17. Summary_Deforestation:\nThe texts primarily focus on environmental conservation and efforts to combat climate change. They highlight the importance of preserving forests like the Tongass National Forest in Alaska, emphasizing their role in storing carbon, providing habitat, and mitigating climate change effects. They urge readers to take action, such as signing petitions or participating in tree-planting initiatives. Some texts discuss the potential benefits of 'super trees' that are more effective at carbon storage and stress the importance of preserving mature trees in the face of climate change. Overall, the texts call for collective action to protect and restore natural environments and address climate-related challenges by planting more trees and preserving forests.\n\n18. Summary_Carbon:\nThese texts collectively emphasize the importance of reducing carbon emissions and mitigating one's carbon footprint. They introduce various strategies and initiatives for individuals and communities to lower their carbon impact, such as carbon pricing, using energy-efficient lights, enrolling in carbon reduction programs, calculating personal carbon footprints, offsetting tailpipe emissions, and supporting sustainability efforts in industries like cement and concrete. The overarching theme is the need for environmental awareness and action to combat climate change and promote a more sustainable future.\n\n19. Summary_CustomerBasedAltEnergy:\nThese texts collectively highlight various aspects of renewable and sustainable energy sources. They address common myths and misconceptions about solar energy, emphasizing its versatility and suitability for different types of buildings and applications. They promote community solar programs in Illinois, offer information and resources for learning about solar power, and invite individuals to explore solar technology and installations. Additionally, the texts touch upon other forms of renewable energy, such as wind and nuclear power, showcasing their potential to provide reliable, clean energy and create jobs in various states. The overarching theme is the promotion and education about renewable energy sources and their benefits.\n\n20. Summary_FoodSecurity:\nThe provided texts collectively address the complexities of food security, emphasizing the global nature of the challenge and the need for cross-sector collaboration to meet the increasing food demand caused by a growing global population and climate change. They also shed light on issues of food justice and sovereignty, particularly in marginalized communities, where access to healthy foods is limited. Additionally, the texts discuss the concept of food elitism, questioning marketing practices and their impact on food equity, arguing for the importance of affordable and sustainable food systems. Furthermore, the issue of food deserts is explored, where residents face challenges related to the availability, accessibility, and affordability of nutritious food, with a recognition of the intricate factors contributing to food insecurity. These texts collectively stress the urgency of addressing food-related challenges from multiple perspectives, encompassing policy, social justice, and sustainable agriculture.\n\n21. Summary_EnergyAffordabilityandSustainabilityLegislation:\nThese texts all convey similar messages, focusing on various representatives, including Rep. John Autry, Rep. Kelly Alexander, Rep. Kyle Hall, Rep. John Sauls, and Rep. John A. Torbett, who are collectively working to reduce power bills for families and businesses in North Carolina. They sponsor legislation aimed at exploring changes that could potentially result in annual energy bill reductions exceeding $600 million. The texts encourage readers to learn more about the Alliance for Energy Security's collaboration with policymakers in an effort to make energy in North Carolina more affordable, environmentally friendly, and dependable.\n\n22. Summary_EcofriendlyConsumerChoices:\nThe broader theme of these texts is environmental sustainability and eco-conscious consumer choices. They focus on promoting a laundry detergent product that aligns with sustainability goals by offering a range of environmentally friendly features, such as being cruelty-free, using minimal plastic packaging, and supporting carbon-neutral shipping. The theme encourages individuals to make environmentally responsible choices in their daily lives, particularly in the context of laundry and reducing plastic waste.\n\n23. Summary_PlasticWasteandEnvironmentalImpact:\nThe overall summary of these texts is a collective call to address the urgent issue of plastic waste and pollution in the environment. They highlight the alarming amount of plastic entering our oceans, stress the need for collective action involving both consumers and brands to combat this crisis, introduce innovative solutions like pyrolysis to reduce plastic waste and carbon footprints, and emphasize the importance of better handling and regulation within the petrochemical industry to prevent plastic pollution. The texts underscore the broader theme of environmental responsibility and the imperative to find sustainable alternatives to single-use plastics and improve the entire plastic production and waste management lifecycle.\n\n24. Summary_PromoteSustainableTransportation: \nThese texts collectively emphasize the importance of electric vehicles (EVs) in combating air pollution and improving air quality. They highlight the role of clean car standards and the accessibility of EVs, particularly in Los Angeles, where local rebate programs make them a cost-effective choice. Shifting from gas-powered vehicles to electric options is promoted for its potential to reduce emissions and decrease exposure to pollution, with a focus on the environmental and health benefits of adopting EVs and the need to take steps to clean the air in Colorado and beyond.\n\n25. Summary_WaterManagementandSustainability:\nThese texts collectively emphasize the discussion of water treatment and billing issues in various cities. The texts touch upon topics such as the cost of building new water treatment plants versus refurbishing existing ones, concerns about water quality and the presence of toxic chemicals in tap water, allegations of potential corruption or kickbacks in decision-making processes, and the financial aspects of water billing, including rates, fees, and expenditures related to water infrastructure. Additionally, some texts emphasize the importance of proper maintenance and infrastructure investment to ensure clean and safe drinking water for residents.\n\nText: Alaska’s Tongass National Forest absorbs more carbon than all other national forests.\nQuestion: Which summary does this text match the most?\nAnswer: Summary_Deforestation\n\nText: Tens of millions of people depend on healthy oceans and abundant seafood. The knowledge we’re gaining about the impacts of climate change on fisheries – and the ways fishers will need to adapt – will help inform our oceans work over the next five years.\nQuestion: Which summary does this text match the most?\nAnswer: Summary_Animals\n\nText: Hey, there – I’m Sol Sandoval, and I'm running for Congress to defeat far-right conspiracist GOP Congresswoman Lauren Boebert. For too long, leaders in Washington have failed to understand our struggles — and it's time to send another progressive voice for working people to fight for us in Congress. That’s why I’ll never shy away from key values like health care as a basic human right, climate justice, and quality education for every student.\nTogether, we have the power to build a future that we can be proud of, but I'll need you on my team. Will you chip in to my campaign for Congress to unseat far-right, pro-Trump Lauren Boebert and replace her with a true voice for our progressive, working-class values?\nQuestion: Which summary does this text match the most?\nAnswer: Summary_AgainstCorporateInterests\n\nText: "+shortened_text+"\nQuestion: Which summary does this text match the most? If you do not find the most possible match, please provide the possible closest one match from those summaries.\nAnswer: ?" 
    token_count = len(tokenizer.encode(user_message))
    #print("Number of tokens:", token_count)
    if (token_count+40) < 4000:
        # Call the function to make the API request and handle rate limits
        assistant_reply = make_api_request(user_message)
        # Append the assistant's reply to the list
        assistant_replies.append(assistant_reply)
    elif (token_count+40) >= 4000:
        # Call the function to make the API request and handle rate limits
        assistant_reply = make_api_request(user_message[:3950])
        # Append the assistant's reply to the list
        assistant_replies.append(assistant_reply)

# Add the assistant's replies to the DataFrame
df['assistant_reply'] = assistant_replies

# Print or save the updated DataFrame with assistant's replies
df.to_csv('data/chatgpt_theme_climate.csv')


